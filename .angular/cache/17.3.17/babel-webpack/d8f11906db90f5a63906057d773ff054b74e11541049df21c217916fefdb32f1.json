{"ast":null,"code":"import { interval, switchMap, shareReplay, startWith } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport class GasolinerasService {\n  constructor(http) {\n    this.http = http;\n    // URL de la API pública del MITECO\n    this.API_URL = 'https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/';\n    // Intervalo de actualización (5 minutos)\n    this.REFRESH_INTERVAL = 5 * 60 * 1000;\n    // Cache observable para evitar peticiones duplicadas\n    this.gasolineras$ = null;\n  }\n  /**\n   * Obtiene todas las gasolineras con actualización automática\n   */\n  obtenerGasolineras() {\n    if (!this.gasolineras$) {\n      this.gasolineras$ = interval(this.REFRESH_INTERVAL).pipe(startWith(0),\n      // Emite inmediatamente\n      switchMap(() => this.fetchGasolineras()), shareReplay(1) // Comparte la última emisión entre suscriptores\n      );\n    }\n    return this.gasolineras$;\n  }\n  /**\n   * Obtiene las gasolineras de una provincia específica\n   */\n  obtenerGasolinerasPorProvincia(provincia) {\n    return this.obtenerGasolineras().pipe(map(gasolineras => gasolineras.filter(g => g.provincia.toLowerCase().includes(provincia.toLowerCase()))));\n  }\n  /**\n   * Obtiene las gasolineras de una localidad específica\n   */\n  obtenerGasolinerasPorLocalidad(localidad) {\n    return this.obtenerGasolineras().pipe(map(gasolineras => gasolineras.filter(g => g.localidad.toLowerCase().includes(localidad.toLowerCase()))));\n  }\n  /**\n   * Busca gasolineras por código postal\n   */\n  obtenerGasolinerasPorCP(codigoPostal) {\n    return this.obtenerGasolineras().pipe(map(gasolineras => gasolineras.filter(g => g.codigoPostal.includes(codigoPostal))));\n  }\n  /**\n   * Obtiene las gasolineras más baratas para un tipo de combustible\n   */\n  obtenerMasBaratas(tipoCombustible, limite = 10) {\n    return this.obtenerGasolineras().pipe(map(gasolineras => {\n      return gasolineras.filter(g => g.precios[tipoCombustible] && g.precios[tipoCombustible] > 0).sort((a, b) => {\n        const precioA = a.precios[tipoCombustible] || Infinity;\n        const precioB = b.precios[tipoCombustible] || Infinity;\n        return precioA - precioB;\n      }).slice(0, limite);\n    }));\n  }\n  /**\n   * Realiza la petición HTTP a la API del MITECO\n   */\n  fetchGasolineras() {\n    return this.http.get(this.API_URL).pipe(map(response => this.transformarDatos(response.ListaEESSPrecio)));\n  }\n  /**\n   * Transforma los datos de la API al formato simplificado\n   */\n  transformarDatos(gasolineras) {\n    return gasolineras.map(g => ({\n      id: g['IDEESS'],\n      nombre: g['Rótulo'] || 'Sin nombre',\n      direccion: g['Dirección'],\n      localidad: g['Localidad'],\n      provincia: g['Provincia'],\n      codigoPostal: g['C.P.'],\n      horario: g['Horario'] || 'No disponible',\n      latitud: this.parsearCoordenada(g['Latitud']),\n      longitud: this.parsearCoordenada(g['Longitud (WGS84)']),\n      precios: {\n        gasolina95: this.parsearPrecio(g['Precio Gasolina 95 E5']),\n        gasolina98: this.parsearPrecio(g['Precio Gasolina 98 E5']),\n        diesel: this.parsearPrecio(g['Precio Gasoleo A']),\n        dieselPremium: this.parsearPrecio(g['Precio Gasoleo Premium']),\n        bioetanol: this.parsearPrecio(g['Precio Bioetanol']),\n        biodiesel: this.parsearPrecio(g['Precio Biodiesel']),\n        gnc: this.parsearPrecio(g['Precio Gas Natural Comprimido']),\n        glp: this.parsearPrecio(g['Precio Gases licuados del petróleo'])\n      }\n    }));\n  }\n  /**\n   * Convierte string de precio a número\n   */\n  parsearPrecio(precio) {\n    if (!precio || precio.trim() === '') return undefined;\n    const precioLimpio = precio.replace(',', '.');\n    const numero = parseFloat(precioLimpio);\n    return isNaN(numero) ? undefined : numero;\n  }\n  /**\n   * Convierte coordenada de string a número\n   */\n  parsearCoordenada(coordenada) {\n    if (!coordenada) return 0;\n    const coordenadaLimpia = coordenada.replace(',', '.');\n    return parseFloat(coordenadaLimpia) || 0;\n  }\n  /**\n   * Invalida el cache para forzar actualización\n   */\n  refrescar() {\n    this.gasolineras$ = null;\n  }\n  static {\n    this.ɵfac = function GasolinerasService_Factory(t) {\n      return new (t || GasolinerasService)(i0.ɵɵinject(i1.HttpClient));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: GasolinerasService,\n      factory: GasolinerasService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"names":["interval","switchMap","shareReplay","startWith","map","GasolinerasService","constructor","http","API_URL","REFRESH_INTERVAL","gasolineras$","obtenerGasolineras","pipe","fetchGasolineras","obtenerGasolinerasPorProvincia","provincia","gasolineras","filter","g","toLowerCase","includes","obtenerGasolinerasPorLocalidad","localidad","obtenerGasolinerasPorCP","codigoPostal","obtenerMasBaratas","tipoCombustible","limite","precios","sort","a","b","precioA","Infinity","precioB","slice","get","response","transformarDatos","ListaEESSPrecio","id","nombre","direccion","horario","latitud","parsearCoordenada","longitud","gasolina95","parsearPrecio","gasolina98","diesel","dieselPremium","bioetanol","biodiesel","gnc","glp","precio","trim","undefined","precioLimpio","replace","numero","parseFloat","isNaN","coordenada","coordenadaLimpia","refrescar","i0","ɵɵinject","i1","HttpClient","factory","ɵfac","providedIn"],"sources":["/Users/niicogarciia/AplicacionGasolineras/src/app/services/gasolineras.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { Observable, interval, switchMap, shareReplay, startWith } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport { ApiResponse, Gasolinera, GasolineraSimplificada, PreciosCombustible } from '../models/gasolinera.model';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class GasolinerasService {\n  // URL de la API pública del MITECO\n  private readonly API_URL = 'https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/';\n  \n  // Intervalo de actualización (5 minutos)\n  private readonly REFRESH_INTERVAL = 5 * 60 * 1000;\n  \n  // Cache observable para evitar peticiones duplicadas\n  private gasolineras$: Observable<GasolineraSimplificada[]> | null = null;\n\n  constructor(private http: HttpClient) {}\n\n  /**\n   * Obtiene todas las gasolineras con actualización automática\n   */\n  obtenerGasolineras(): Observable<GasolineraSimplificada[]> {\n    if (!this.gasolineras$) {\n      this.gasolineras$ = interval(this.REFRESH_INTERVAL).pipe(\n        startWith(0), // Emite inmediatamente\n        switchMap(() => this.fetchGasolineras()),\n        shareReplay(1) // Comparte la última emisión entre suscriptores\n      );\n    }\n    return this.gasolineras$;\n  }\n\n  /**\n   * Obtiene las gasolineras de una provincia específica\n   */\n  obtenerGasolinerasPorProvincia(provincia: string): Observable<GasolineraSimplificada[]> {\n    return this.obtenerGasolineras().pipe(\n      map(gasolineras => gasolineras.filter(g => \n        g.provincia.toLowerCase().includes(provincia.toLowerCase())\n      ))\n    );\n  }\n\n  /**\n   * Obtiene las gasolineras de una localidad específica\n   */\n  obtenerGasolinerasPorLocalidad(localidad: string): Observable<GasolineraSimplificada[]> {\n    return this.obtenerGasolineras().pipe(\n      map(gasolineras => gasolineras.filter(g => \n        g.localidad.toLowerCase().includes(localidad.toLowerCase())\n      ))\n    );\n  }\n\n  /**\n   * Busca gasolineras por código postal\n   */\n  obtenerGasolinerasPorCP(codigoPostal: string): Observable<GasolineraSimplificada[]> {\n    return this.obtenerGasolineras().pipe(\n      map(gasolineras => gasolineras.filter(g => \n        g.codigoPostal.includes(codigoPostal)\n      ))\n    );\n  }\n\n  /**\n   * Obtiene las gasolineras más baratas para un tipo de combustible\n   */\n  obtenerMasBaratas(tipoCombustible: keyof PreciosCombustible, limite: number = 10): Observable<GasolineraSimplificada[]> {\n    return this.obtenerGasolineras().pipe(\n      map(gasolineras => {\n        return gasolineras\n          .filter(g => g.precios[tipoCombustible] && g.precios[tipoCombustible]! > 0)\n          .sort((a, b) => {\n            const precioA = a.precios[tipoCombustible] || Infinity;\n            const precioB = b.precios[tipoCombustible] || Infinity;\n            return precioA - precioB;\n          })\n          .slice(0, limite);\n      })\n    );\n  }\n\n  /**\n   * Realiza la petición HTTP a la API del MITECO\n   */\n  private fetchGasolineras(): Observable<GasolineraSimplificada[]> {\n    return this.http.get<ApiResponse>(this.API_URL).pipe(\n      map(response => this.transformarDatos(response.ListaEESSPrecio))\n    );\n  }\n\n  /**\n   * Transforma los datos de la API al formato simplificado\n   */\n  private transformarDatos(gasolineras: Gasolinera[]): GasolineraSimplificada[] {\n    return gasolineras.map(g => ({\n      id: g['IDEESS'],\n      nombre: g['Rótulo'] || 'Sin nombre',\n      direccion: g['Dirección'],\n      localidad: g['Localidad'],\n      provincia: g['Provincia'],\n      codigoPostal: g['C.P.'],\n      horario: g['Horario'] || 'No disponible',\n      latitud: this.parsearCoordenada(g['Latitud']),\n      longitud: this.parsearCoordenada(g['Longitud (WGS84)']),\n      precios: {\n        gasolina95: this.parsearPrecio(g['Precio Gasolina 95 E5']),\n        gasolina98: this.parsearPrecio(g['Precio Gasolina 98 E5']),\n        diesel: this.parsearPrecio(g['Precio Gasoleo A']),\n        dieselPremium: this.parsearPrecio(g['Precio Gasoleo Premium']),\n        bioetanol: this.parsearPrecio(g['Precio Bioetanol']),\n        biodiesel: this.parsearPrecio(g['Precio Biodiesel']),\n        gnc: this.parsearPrecio(g['Precio Gas Natural Comprimido']),\n        glp: this.parsearPrecio(g['Precio Gases licuados del petróleo'])\n      }\n    }));\n  }\n\n  /**\n   * Convierte string de precio a número\n   */\n  private parsearPrecio(precio: string): number | undefined {\n    if (!precio || precio.trim() === '') return undefined;\n    const precioLimpio = precio.replace(',', '.');\n    const numero = parseFloat(precioLimpio);\n    return isNaN(numero) ? undefined : numero;\n  }\n\n  /**\n   * Convierte coordenada de string a número\n   */\n  private parsearCoordenada(coordenada: string): number {\n    if (!coordenada) return 0;\n    const coordenadaLimpia = coordenada.replace(',', '.');\n    return parseFloat(coordenadaLimpia) || 0;\n  }\n\n  /**\n   * Invalida el cache para forzar actualización\n   */\n  refrescar(): void {\n    this.gasolineras$ = null;\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}