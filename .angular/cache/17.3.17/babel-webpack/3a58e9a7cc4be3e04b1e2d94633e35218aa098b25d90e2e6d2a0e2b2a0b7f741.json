{"ast":null,"code":"import { interval, switchMap, shareReplay, startWith } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport let GasolinerasService = /*#__PURE__*/(() => {\n  class GasolinerasService {\n    constructor(http) {\n      this.http = http;\n      // URL de la API pública del MITECO\n      this.API_URL = 'https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/';\n      // Intervalo de actualización (5 minutos)\n      this.REFRESH_INTERVAL = 5 * 60 * 1000;\n      // Cache observable para evitar peticiones duplicadas\n      this.gasolineras$ = null;\n    }\n    /**\n     * Obtiene todas las gasolineras con actualización automática\n     */\n    obtenerGasolineras() {\n      if (!this.gasolineras$) {\n        this.gasolineras$ = interval(this.REFRESH_INTERVAL).pipe(startWith(0),\n        // Emite inmediatamente\n        switchMap(() => this.fetchGasolineras()), shareReplay(1) // Comparte la última emisión entre suscriptores\n        );\n      }\n      return this.gasolineras$;\n    }\n    /**\n     * Obtiene las gasolineras de una provincia específica\n     */\n    obtenerGasolinerasPorProvincia(provincia) {\n      return this.obtenerGasolineras().pipe(map(gasolineras => gasolineras.filter(g => g.provincia.toLowerCase().includes(provincia.toLowerCase()))));\n    }\n    /**\n     * Obtiene las gasolineras de una localidad específica\n     */\n    obtenerGasolinerasPorLocalidad(localidad) {\n      return this.obtenerGasolineras().pipe(map(gasolineras => gasolineras.filter(g => g.localidad.toLowerCase().includes(localidad.toLowerCase()))));\n    }\n    /**\n     * Busca gasolineras por código postal\n     */\n    obtenerGasolinerasPorCP(codigoPostal) {\n      return this.obtenerGasolineras().pipe(map(gasolineras => gasolineras.filter(g => g.codigoPostal.includes(codigoPostal))));\n    }\n    /**\n     * Obtiene las gasolineras más baratas para un tipo de combustible\n     */\n    obtenerMasBaratas(tipoCombustible, limite = 10) {\n      return this.obtenerGasolineras().pipe(map(gasolineras => {\n        return gasolineras.filter(g => g.precios[tipoCombustible] && g.precios[tipoCombustible] > 0).sort((a, b) => {\n          const precioA = a.precios[tipoCombustible] || Infinity;\n          const precioB = b.precios[tipoCombustible] || Infinity;\n          return precioA - precioB;\n        }).slice(0, limite);\n      }));\n    }\n    /**\n     * Realiza la petición HTTP a la API del MITECO\n     */\n    fetchGasolineras() {\n      return this.http.get(this.API_URL).pipe(map(response => this.transformarDatos(response.ListaEESSPrecio)));\n    }\n    /**\n     * Transforma los datos de la API al formato simplificado\n     */\n    transformarDatos(gasolineras) {\n      return gasolineras.map(g => ({\n        id: g['IDEESS'],\n        nombre: g['Rótulo'] || 'Sin nombre',\n        direccion: g['Dirección'],\n        localidad: g['Localidad'],\n        provincia: g['Provincia'],\n        codigoPostal: g['C.P.'],\n        horario: g['Horario'] || 'No disponible',\n        latitud: this.parsearCoordenada(g['Latitud']),\n        longitud: this.parsearCoordenada(g['Longitud (WGS84)']),\n        precios: {\n          gasolina95: this.parsearPrecio(g['Precio Gasolina 95 E5']),\n          gasolina98: this.parsearPrecio(g['Precio Gasolina 98 E5']),\n          diesel: this.parsearPrecio(g['Precio Gasoleo A']),\n          dieselPremium: this.parsearPrecio(g['Precio Gasoleo Premium']),\n          bioetanol: this.parsearPrecio(g['Precio Bioetanol']),\n          biodiesel: this.parsearPrecio(g['Precio Biodiesel']),\n          gnc: this.parsearPrecio(g['Precio Gas Natural Comprimido']),\n          glp: this.parsearPrecio(g['Precio Gases licuados del petróleo'])\n        }\n      }));\n    }\n    /**\n     * Convierte string de precio a número\n     */\n    parsearPrecio(precio) {\n      if (!precio || precio.trim() === '') return undefined;\n      const precioLimpio = precio.replace(',', '.');\n      const numero = parseFloat(precioLimpio);\n      return isNaN(numero) ? undefined : numero;\n    }\n    /**\n     * Convierte coordenada de string a número\n     */\n    parsearCoordenada(coordenada) {\n      if (!coordenada) return 0;\n      const coordenadaLimpia = coordenada.replace(',', '.');\n      return parseFloat(coordenadaLimpia) || 0;\n    }\n    /**\n     * Invalida el cache para forzar actualización\n     */\n    refrescar() {\n      this.gasolineras$ = null;\n    }\n    static {\n      this.ɵfac = function GasolinerasService_Factory(t) {\n        return new (t || GasolinerasService)(i0.ɵɵinject(i1.HttpClient));\n      };\n    }\n    static {\n      this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n        token: GasolinerasService,\n        factory: GasolinerasService.ɵfac,\n        providedIn: 'root'\n      });\n    }\n  }\n  return GasolinerasService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}